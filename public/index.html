<!DOCTYPE html>
<html>
<head>
    <title>Find Castles</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body
    class="mx-8 min-h-screen flex flex-col p-3">
    <header
        class="
            flex 
            w-full
            justify-between
            items-center">
        <a href="/">Castles Finder</a>
        <nav>
            <ul>
                <li><a href="https://github.com/buarki/find-castles" target="_blank">Github</a></li>
            </ul>
        </nav>
    </header>
    <div class="my-3">
        <button
            id="searchButton"
            title="Search for castles"
            class="
                bg-blue-400
                hover:bg-blue-300
                text-white
                p-1
            "
            onclick="search()">
            Search
        </button>
    </div>

    <div
        class="w-full flex gap-5 flex-grow"
        id="country-castles">
    </div>

    <footer class="flex items-center justify-center bg-white p-4 mt-3">
        <p title="Visit author's site.">Made with love by <a target='_blank' class='underline hover:bg-blue-400 p-1 hover:text-white' href='https://buarki.com'>buarki.com.</a></p>
    </footer>


    <script>
        let sse;
        const castlesArea = document.getElementById("country-castles");
        const searchButton = document.getElementById("searchButton");

        const castleCard = ({ name, country, state, city }) => `
            <div class="p-2 bg-red-300 my-3">
                <p class="text-2xl">${name}</p>
                <p>${country}</p>
                <p>${state}</p>
                <p>${city}</p>
            </div>
        `;

        function CountrySection({ id, flagLink }) {
            const countryDiv = document.createElement("div");
            countryDiv.innerHTML = `
                <div id="${id}" class="flex-grow flex flex-col bg-gren-300">
                    <div class="flex gap-3 items-center mb-3">
                        <p class="text-2xl">${ id }</p>
                        <img src="${flagLink}" class="w-10 h-auto"/>
                    </div>
                    <p>Found <span id="${id}-castles-counter">0</span> Castles</p>
                    <ul id="${id}-list" class="flex flex-col gap-3">
                    </ul>
                </div>
            `;
            return countryDiv;
        }

        function handleSSE(event) {
            var data = JSON.parse(event.data);
            if (data.finished) {
                console.log(">>>CLOSED");
                sse.close();
                sse = null;
            } else {
                const castleData = data.message;

                let countryDiv = document.getElementById(castleData.country);
                if (!countryDiv) {
                    countryDiv = CountrySection({ id: castleData.country, flagLink: castleData.flagLink, });
                    castlesArea.appendChild(countryDiv);
                }

                const castlesList  = document.getElementById(`${castleData.country}-list`);
                castlesList.innerHTML += castleCard({...castleData});

                const castlesCounter  = document.getElementById(`${castleData.country}-castles-counter`);
                castlesCounter.innerHTML = parseInt(castlesCounter.innerHTML, 10) + 1;
            }

        }

        function onFinish(event) {
            console.log("Search finished!");
            sse.close();
            sse = null;
        }

        function cancelSearch() {
            sse.close();
            sse = null;

            searchButton.disabled = true;
            searchButton.textContent = "Search";
            searchButton.onclick = search;
            searchButton.classList.remove("bg-red-400");
            searchButton.classList.remove("hover:bg-red-300");
            searchButton.classList.add("bg-blue-400");
            searchButton.classList.add("hover:bg-blue-300");
            searchButton.disabled = false;

        }

        function search() {
            searchButton.disabled = true;
            searchButton.textContent = "Cancel";
            searchButton.classList.remove("bg-blue-400");
            searchButton.classList.remove("hover:bg-blue-300");
            searchButton.classList.add("bg-red-400");
            searchButton.classList.add("hover:bg-red-300");
            searchButton.onclick = cancelSearch;
            searchButton.disabled = false;
            

            console.log(">>> CALLED");
            sse = new EventSource("/sse");
    
            sse.addEventListener("message", handleSSE);
            sse.addEventListener("finished", onFinish);
    
            sse.onerror = function(event) {
                console.error("SSE error:", event);
            };
    
            window.onunload = function() {
                sse.close();
            };
        }
    </script>
</body>
</html>
